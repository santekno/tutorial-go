FROM golang:1.19-alpine as build

RUN apk update
RUN apk add --no-cache git

WORKDIR /go/src/app
COPY . .

RUN go mod download
# RUN go vet -v
# RUN go test -v
RUN go mod tidy

RUN CGO_ENABLED=0 go build -o /go/bin/app /go/src/app/cmd/api/main.go

FROM gcr.io/distroless/static-debian11

ARG APP_PORT=1234
ARG MYSQL_DBURL

EXPOSE ${APP_PORT}

ENV APP_PORT ${APP_PORT}
ENV MYSQL_DBURL ${MYSQL_DBURL}

COPY --from=build /go/bin/app /bin/

ENTRYPOINT ["/bin/app"]
